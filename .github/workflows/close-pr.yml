name: Close External PRs

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  close-external-pr:
    permissions:
      contents: write
      issues: write
    runs-on: ubuntu-latest
    steps:
      - name: Get pnpm store directory
        id: is-fork
        run: |
          echo "is-fork=${{ github.event.pull_request.head.repo.fork }}" >> $GITHUB_OUTPUT

      - name: Close PR if from external collaborators
        if: ${{ steps.is-fork.outputs.is-fork == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const commentBody = `
              Thank you for your contribution!

              Unfortunately, we are no longer accepting pull requests from external collaborators due to the high volume of PRs we have to deal with daily.
              We have reached a point in which it has become too complicated to validate, test and maintain this huge amount of apps resulting in a poor experience for our users.

              We are working at the moment to implement a new feature to allow you to add multiple app stores to your Runtipi instance, so you can add your own apps without the need to send a PR to our repository.
              This feature will be available very soon, so stay tuned! In the mean time, if you really need your app in Runtipi, you can add your own repository to your Runtipi instance [relevant docs](https://runtipi.io/docs/contributing/running-locally#using-your-own-appstore-repository)
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody,
            });

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              state: 'closed',
            });
