{
  "services": [
    {
      "name": "plausible-ce",
      "image": "ghcr.io/plausible/community-edition:v2.1.5",
      "command": "sh -c 'sleep 10 && /entrypoint.sh db createdb && /entrypoint.sh db migrate && /entrypoint.sh run'",
      "internalPort": 8000,
      "isMain": true,
      "environment": [
        {
          "key": "BASE_URL",
          "value": "${APP_PROTOCOL:-http}://${APP_DOMAIN}"
        },
        {
          "key": "SECRET_KEY_BASE",
          "value": "${PLAUSIBLE_SECRET_KEY_BASE}"
        },
        {
          "key": "DATABASE_URL",
          "value": "postgres://tipi:${PLAUSIBLE_DB_PASSWORD}@plausible-db:5432/plausible-db"
        },
        {
          "key": "CLICKHOUSE_DATABASE_URL",
          "value": "http://plausible-events-db:8123/plausible_events_db"
        },
        {
          "key": "DISABLE_REGISTRATION",
          "value": "${PLAUSIBLE_DISABLE_REGISTRATION:-invite-only}"
        },
        {
          "key": "ENABLE_EMAIL_VERIFICATION",
          "value": "${PLAUSIBLE_ENABLE_EMAIL_VERIFICATION:-false}"
        },
        {
          "key": "TOTP_VAULT_KEY",
          "value": "${PLAUSIBLE_TOTP_VAULT_KEY}"
        },
        {
          "key": "GOOGLE_CLIENT_ID",
          "value": "${PLAUSIBLE_GOOGLE_CLIENT_ID}"
        },
        {
          "key": "GOOGLE_CLIENT_SECRET",
          "value": "${PLAUSIBLE_GOOGLE_CLIENT_SECRET}"
        },
        {
          "key": "MAXMIND_LICENSE_KEY",
          "value": "${PLAUSIBLE_MAXMIND_LICENSE_KEY}"
        },
        {
          "key": "MAXMIND_EDITION",
          "value": "${PLAUSIBLE_MAXMIND_EDITION:-GeoLite2-City}"
        },
        {
          "key": "MAILER_ADAPTER",
          "value": "${PLAUSIBLE_MAILER_ADAPTER:-Bamboo.SMTPAdapter}"
        },
        {
          "key": "MAILER_EMAIL",
          "value": "${PLAUSIBLE_MAILER_EMAIL:-plausible@${APP_DOMAIN}}"
        },
        {
          "key": "MAILER_NAME",
          "value": "${PLAUSIBLE_MAILER_NAME:-Plausible}"
        },
        {
          "key": "SMTP_HOST_ADDR",
          "value": "${PLAUSIBLE_SMTP_HOST_ADDR}"
        },
        {
          "key": "SMTP_HOST_PORT",
          "value": "${PLAUSIBLE_SMTP_HOST_PORT}"
        },
        {
          "key": "SMTP_USER_NAME",
          "value": "${PLAUSIBLE_SMTP_USER_NAME}"
        },
        {
          "key": "SMTP_USER_PWD",
          "value": "${PLAUSIBLE_SMTP_USER_PWD}"
        },
        {
          "key": "SMTP_HOST_SSL_ENABLED",
          "value": "${PLAUSIBLE_SMTP_HOST_SSL_ENABLED:-false}"
        },
        {
          "key": "SMTP_RETRIES",
          "value": "${PLAUSIBLE_SMTP_RETRIES:-2}"
        },
        {
          "key": "POSTMARK_API_KEY",
          "value": "${PLAUSIBLE_POSTMARK_API_KEY}"
        },
        {
          "key": "MAILGUN_API_KEY",
          "value": "${PLAUSIBLE_MAILGUN_API_KEY}"
        },
        {
          "key": "MAILGUN_DOMAIN",
          "value": "${PLAUSIBLE_MAILGUN_DOMAIN}"
        },
        {
          "key": "MAILGUN_BASE_URI",
          "value": "${PLAUSIBLE_MAILGUN_BASE_URI:-https://api.mailgun.net/v3}"
        },
        {
          "key": "MANDRILL_API_KEY",
          "value": "${PLAUSIBLE_MANDRILL_API_KEY}"
        },
        {
          "key": "SENDGRID_API_KEY",
          "value": "${PLAUSIBLE_SENDGRID_API_KEY}"
        }
      ],
      "dependsOn": {
        "plausible-db": {
          "condition": "service_healthy"
        },
        "plausible-events-db": {
          "condition": "service_started"
        }
      }
    },
    {
      "name": "plausible-db",
      "image": "postgres:16-alpine",
      "environment": [
        {
          "key": "POSTGRES_DB",
          "value": "plausible-db"
        },
        {
          "key": "POSTGRES_USER",
          "value": "tipi"
        },
        {
          "key": "POSTGRES_PASSWORD",
          "value": "${PLAUSIBLE_DB_PASSWORD}"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/database",
          "containerPath": "/var/lib/postgresql/data"
        }
      ],
      "healthCheck": {
        "timeout": "5s",
        "retries": 3,
        "test": "pg_isready -d plausible-db -U tipi"
      }
    },
    {
      "name": "plausible-events-db",
      "image": "clickhouse/clickhouse-server:25.12.2.54-alpine",
      "environment": [
        {
          "key": "POSTGRES_DB",
          "value": "plausible-db"
        },
        {
          "key": "POSTGRES_USER",
          "value": "tipi"
        },
        {
          "key": "POSTGRES_PASSWORD",
          "value": "${PLAUSIBLE_DB_PASSWORD}"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/event-data",
          "containerPath": "/var/lib/clickhouse"
        },
        {
          "hostPath": "${APP_DATA_DIR}/data/event-logs",
          "containerPath": "/var/log/clickhouse-server"
        },
        {
          "hostPath": "${APP_DATA_DIR}/data/clickhouse/clickhouse-config.xml",
          "containerPath": "/etc/clickhouse-server/config.d/logging.xml",
          "readOnly": true
        },
        {
          "hostPath": "${APP_DATA_DIR}/data/clickhouse/clickhouse-user-config.xml",
          "containerPath": "/etc/clickhouse-server/users.d/logging.xml",
          "readOnly": true
        }
      ]
    }
  ],
  "schemaVersion": 2,
  "$schema": "https://schemas.runtipi.io/v2/dynamic-compose.json"
}
