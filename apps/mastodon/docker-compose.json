{
  "services": [
    {
      "name": "mastodon",
      "image": "lscr.io/linuxserver/mastodon:4.4.8",
      "isMain": true,
      "internalPort": 443,
      "environment": [
        {
          "key": "PUID",
          "value": "1000"
        },
        {
          "key": "PGID",
          "value": "1000"
        },
        {
          "key": "TZ",
          "value": "${TZ}"
        },
        {
          "key": "LOCAL_DOMAIN",
          "value": "${MASTODON_LOCAL_DOMAIN}"
        },
        {
          "key": "WEB_DOMAIN",
          "value": "${APP_DOMAIN}"
        },
        {
          "key": "VAPID_PUBLIC_KEY",
          "value": "${VAPID_PUBLIC_KEY}"
        },
        {
          "key": "VAPID_PRIVATE_KEY",
          "value": "${VAPID_PRIVATE_KEY}"
        },
        {
          "key": "REDIS_HOST",
          "value": "mastodon-redis"
        },
        {
          "key": "REDIS_PASSWORD",
          "value": "${MASTODON_REDIS_PASSWORD}"
        },
        {
          "key": "REDIS_PORT",
          "value": "6379"
        },
        {
          "key": "DB_HOST",
          "value": "mastodon-db"
        },
        {
          "key": "DB_USER",
          "value": "tipi"
        },
        {
          "key": "DB_NAME",
          "value": "mastodon"
        },
        {
          "key": "DB_PASS",
          "value": "${MASTODON_POSTGRES_PASSWORD}"
        },
        {
          "key": "DB_PORT",
          "value": "5432"
        },
        {
          "key": "ES_ENABLED",
          "value": "false"
        },
        {
          "key": "SECRET_KEY_BASE",
          "value": "${MASTODON_SECRET_KEY_BASE}"
        },
        {
          "key": "OTP_SECRET",
          "value": "${MASTODON_OTP_SECRET}"
        },
        {
          "key": "SMTP_SERVER",
          "value": "${MASTODON_SMTP_SERVER}"
        },
        {
          "key": "SMTP_PORT",
          "value": "${MASTODON_SMTP_PORT}"
        },
        {
          "key": "SMTP_LOGIN",
          "value": "${MASTODON_SMTP_LOGIN}"
        },
        {
          "key": "SMTP_PASSWORD",
          "value": "${MASTODON_SMTP_PASSWORD}"
        },
        {
          "key": "SMTP_FROM_ADDRESS",
          "value": "${MASTODON_SMTP_FROM_ADDRESS}"
        },
        {
          "key": "S3_ENABLED",
          "value": "false"
        },
        {
          "key": "SIDEKIQ_ONLY",
          "value": "false"
        },
        {
          "key": "SIDEKIQ_DEFAULT",
          "value": "false"
        },
        {
          "key": "SIDEKIQ_THREADS",
          "value": "5"
        },
        {
          "key": "ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY",
          "value": "${MASTODON_ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY}"
        },
        {
          "key": "ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT",
          "value": "${MASTODON_ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT}"
        },
        {
          "key": "ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY",
          "value": "${MASTODON_ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY}"
        }
      ],
      "dependsOn": {
        "mastodon-db": {
          "condition": "service_healthy"
        },
        "mastodon-redis": {
          "condition": "service_healthy"
        }
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/mastodon-config",
          "containerPath": "/config"
        }
      ],
      "extraLabels": {
        "traefik.http.services.{{RUNTIPI_APP_ID}}.loadbalancer.serverstransport": "insecuretransport@file",
        "traefik.http.services.{{RUNTIPI_APP_ID}}.loadbalancer.server.scheme": "https"
      }
    },
    {
      "name": "mastodon-db",
      "image": "postgres:14-alpine",
      "environment": [
        {
          "key": "POSTGRES_PASSWORD",
          "value": "${MASTODON_POSTGRES_PASSWORD}"
        },
        {
          "key": "POSTGRES_USER",
          "value": "tipi"
        },
        {
          "key": "POSTGRES_DB",
          "value": "mastodon"
        },
        {
          "key": "PG_DATA",
          "value": "/var/lib/postgresql/data"
        },
        {
          "key": "POSTGRES_HOST_AUTH_METHOD",
          "value": "trust"
        }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/postgres",
          "containerPath": "/var/lib/postgresql/data"
        }
      ],
      "shmSize": "256mb",
      "healthCheck": {
        "test": "pg_isready -U tipi -d mastodon"
      }
    },
    {
      "name": "mastodon-redis",
      "image": "redis:7-alpine",
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/redis",
          "containerPath": "/data"
        }
      ],
      "command": "redis-server --appendonly yes --replica-read-only no --requirepass \"${MASTODON_REDIS_PASSWORD}\"",
      "healthCheck": {
        "test": "redis-cli ping"
      }
    }
  ],
  "schemaVersion": 2,
  "$schema": "https://schemas.runtipi.io/v2/dynamic-compose.json"
}
