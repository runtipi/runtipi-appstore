{
  "schemaVersion": 2,
  "services": [
    {
      "image": "activepieces/activepieces:0.76.1",
      "name": "activepieces",
      "internalPort": 80,
      "isMain": true,
      "dependsOn": {
        "activepieces-postgres": {
          "condition": "service_healthy"
        },
        "activepieces-redis": {
          "condition": "service_healthy"
        }
      },
      "environment": [
        { "key": "AP_ENGINE_EXECUTABLE_PATH", "value": "dist/packages/engine/main.js" },
        { "key": "AP_API_KEY", "value": "${AP_API_KEY}" },
        { "key": "AP_ENCRYPTION_KEY", "value": "${AP_ENCRYPTION_KEY}" },
        { "key": "AP_JWT_SECRET", "value": "${AP_JWT_SECRET}" },
        { "key": "AP_ENVIRONMENT", "value": "prod" },
        { "key": "AP_FRONTEND_URL", "value": "${APP_PROTOCOL:-http}://${APP_DOMAIN}" },
        { "key": "AP_WEBHOOK_TIMEOUT_SECONDS", "value": "30" },
        { "key": "AP_TRIGGER_DEFAULT_POLL_INTERVAL", "value": "5" },
        { "key": "AP_POSTGRES_DATABASE", "value": "activepieces" },
        { "key": "AP_POSTGRES_HOST", "value": "activepieces-postgres" },
        { "key": "AP_POSTGRES_PORT", "value": "5432" },
        { "key": "AP_POSTGRES_USERNAME", "value": "tipi" },
        { "key": "AP_POSTGRES_PASSWORD", "value": "${AP_POSTGRES_PASSWORD}" },
        { "key": "AP_EXECUTION_MODE", "value": "UNSANDBOXED" },
        { "key": "AP_REDIS_HOST", "value": "activepieces-redis" },
        { "key": "AP_REDIS_PORT", "value": "6379" },
        { "key": "AP_SANDBOX_RUN_TIME_SECONDS", "value": "600" },
        { "key": "AP_TELEMETRY_ENABLED", "value": "true" },
        { "key": "AP_TEMPLATES_SOURCE_URL", "value": "https://cloud.activepieces.com/api/v1/flow-templates" }
      ]
    },
    {
      "image": "postgres:14",
      "name": "activepieces-postgres",
      "environment": [
        { "key": "POSTGRES_DB", "value": "activepieces" },
        { "key": "POSTGRES_PASSWORD", "value": "${AP_POSTGRES_PASSWORD}" },
        { "key": "POSTGRES_USER", "value": "tipi" }
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/postgres",
          "containerPath": "/var/lib/postgresql/data"
        }
      ],
      "healthCheck": {
        "test": "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB",
        "interval": "30s",
        "timeout": "30s",
        "retries": 3
      }
    },
    {
      "image": "redis:7",
      "name": "activepieces-redis",
      "healthCheck": {
        "test": "redis-cli ping",
        "interval": "30s",
        "timeout": "30s",
        "retries": 3
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/redis/",
          "containerPath": "/data"
        }
      ]
    }
  ],
  "$schema": "https://schemas.runtipi.io/v2/dynamic-compose.json"
}
